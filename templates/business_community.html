{% extends "base.html" %}

{% block content %}
<style nonce="{{ nonce }}">
    /* body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
    } */
     .imbc-icon{
            /* position: absolute;
            bottom:120px;
            right:15px; */
        }
     .category-title-animated {
        display: inline-block;
        font-weight: 600;
        font-size: 25px;
        font-family: "Montserrat";
        color: #333;
        letter-spacing: 1px;
        overflow: hidden;
        }

    .category-char {
        opacity: 0;
        display: inline-block;
        transition: opacity 0.3s, transform 0.3s;
        transform: translateY(20px);
        /* min-width: 1ch; */
    }

    .category-char.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .business-card {
        max-width: 450px;
        width:100%;
        /* background: #ffffff; */
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.4);
        padding: 20px;
        text-align: center;
    }

    .community-logo {
        /* width: 80px; */
        height: 80px;
        margin: 0 auto 15px;
        border-radius: 15px;
        /* background-color: #0078d7; */
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-size: 24px;
        font-weight: bold;
        /* position: absolute; */
        /* top:15px;
        right:15px; */
    }
    .imbc-icon-comm{
        position: relative !important;
        bottom:none !important;
        right:none !important;
    }
    .imbc-icon-comm img{
        height:65px;
        box-shadow:  0px 1px 3px rgba(0, 0, 0, 0.16);
        border-radius: 15px;
        background-color:#fde7e6;
        transition: all 0.3s ease;
    }
    .company-name {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
        text-align: left;
    }
    .company-details {
        font-size: 14px;
        color: #555;
        margin-bottom: 20px;
    }
    .company-modal-body-content {
    max-height: 90vh;
    overflow-y: auto;
    /* Optional for better look: */
    padding-right: 8px;
    /* Hide scrollbar on Chrome/Safari */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f8fafc;
    }
    .company-modal-body-content::-webkit-scrollbar {
        width: 7px;
        background: #f8fafc;
    }
    .company-modal-body-content::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 6px;
    }
    .links a {
        display: block;
        text-decoration: none;
        color: #0078d7;
        font-size: 14px;
        margin: 5px 0;
    }
    .links a:hover {
        text-decoration: underline;
    }
    .cards-container {
    scroll-behavior: smooth;
    /* Optional: */
    /* scroll-snap-type: x mandatory; */
    }
    .business-card {
    /* scroll-snap-align: start; */
    }
    .grid-view{
        width:95%;
        margin: 0 auto;
        flex-wrap: wrap;justify-content: flex-start;
        /* max-width: ; */
    }
    .company-logos-cards{
        height:120px;
        width:max-content;
        border-radius: 12px;
        overflow: hidden;
    }
    .comp-logos{
        height: inherit !important;
    }
    .list-card{
        min-height: 80px;
        height:max-content;
        width:max-content;
    }
    .toggle-container {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
    }
    .link-overflow-x{
        overflow-x: auto;
    }
.toggle-btn {
    background: #f4f4f4;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 18px;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s, border 0.2s;
}
.toggle-btn span{
    font-size: 15px;
    cursor: pointer;
}
.toggle-btn img{
    height: 25px;
}
.list-view{
    flex-wrap: wrap;justify-content: flex-start;
}
.toggle-btn[aria-pressed="true"] {
    background: #e0e7ff;
    border-color: #3667ef;
    font-weight: bold;
}
.grid-view, .list-view {
    width: 100%;
}
.grid-view .company-logos-cards {
    display: inline-block;
    margin: 10px;
    gap:3px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.2);
}
.list-card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 10px 18px;
    margin: 10px 0;
    min-width: 250px;
    max-width: 300px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
    align-items: center;
}
.comp-logos {
    /* width: 60px;
    height: 60px; */
    object-fit: contain;
    border-radius: 12px;
    background: #f8f8f8;
    /* margin-right: 16px; */
}
.comp_name {
    font-size: 15px;
    font-weight: 600;
}
.comp_services {
    color: #575656;
    font-size: 11px;
    font-weight: 500;
}
/* --- Modern Modal Styles --- */
.company-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(30, 41, 59, 0.55); /* slate-800/60 */
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(2px);
}
.company-modal-content {
  background: linear-gradient(135deg, #f8fafc 60%, #e0e7ef 100%);
  border-radius: 18px;
  max-width: 410px;
  width: 95vw;
  padding: 36px 28px 28px 28px;
  box-shadow: 0 8px 32px rgba(30,41,59,0.18), 0 1.5px 8px rgba(80,80,120,0.08);
  position: relative;
  animation: modalIn 0.22s cubic-bezier(.4,1.4,.6,1);
  border: 1.5px solid #e0e7ef;
  max-height: 95vh;
}
@keyframes modalIn {
  from { transform: translateY(40px) scale(0.98); opacity: 0; }
  to   { transform: none; opacity: 1; }
}
.company-modal-close {
  position: absolute;
  right: 18px; top: 12px;
  font-size: 2.1rem;
  color: #64748b;
  cursor: pointer;
  transition: color 0.18s, transform 0.18s;
  font-weight: 400;
  z-index: 2;
}
.company-modal-close:hover {
  color: #1e293b;
  transform: scale(1.15);
}
.company-modal-loading {
  text-align: center;
  color: #64748b;
  font-size: 1.13em;
  margin: 32px 0 24px 0;
  letter-spacing: 0.02em;
}
.company-modal-body-content {
  text-align: left;
  padding-top: 6px;
}
.company-modal-body-content h2 {
  margin-top: 0.5em;
  font-size: 1.45em;
  color: #1e293b;
  font-weight: 700;
  letter-spacing: 0.01em;
  margin-bottom: 0.2em;
}
.company-modal-body-content .modal-logo {
  width: 84px; height: 84px; object-fit: contain; border-radius: 16px; background: #f1f5f9; margin-bottom: 10px; box-shadow: 0 2px 12px rgba(80,80,120,0.07);
  border: 1.5px solid #e0e7ef;
}
.company-modal-body-content .modal-fields {
  margin-top: 18px;
}
.company-modal-body-content .modal-field {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 13px;
  font-size: 1.04em;
  color: #334155;
  background: #f8fafc;
  border-radius: 7px;
  padding: 7px 10px 7px 8px;
  box-shadow: 0 1px 4px rgba(80,80,120,0.04);
}
.company-modal-body-content .modal-label {
  font-weight: 600;
  color: #475569;
  margin-right: 4px;
  min-width: 28px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.company-modal-body-content .modal-label img {
  width: 30px; height: 30px; object-fit: contain; margin-right: 2px; filter: grayscale(0.2) brightness(0.95);
}
.company-modal-body-content .modal-field a {
  color: #2563eb;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.18s;
}
.company-modal-body-content .modal-field a:hover {
  color: #1e40af;
  text-decoration: underline;
}
@media (max-width: 700px) {
    .list-card { min-width: 90vw; }
}
</style>

<script nonce="{{ nonce }}">
function randomChar() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    return chars[Math.floor(Math.random() * chars.length)];
}

function animateCategoryTitle(el, delayPerChar = 80, scrambleDuration = 600) {
    const text = el.textContent;
    el.textContent = "";
    const chars = [];

    // Wrap each character in a span
    for (let i = 0; i < text.length; i++) {
        const span = document.createElement("span");
        span.className = "category-char";
        span.textContent = " ";
        el.appendChild(span);
        chars.push(span);
    }

    // Animate each character in sequence
    chars.forEach((span, idx) => {
        setTimeout(() => {
            let scrambleTime = 0;
            const originalChar = text[idx];
            // Only animate letters, not spaces
            if (originalChar === " ") {
                span.textContent = " ";
                span.classList.add("visible");
                return;
            }
            // Scramble effect
            const scrambleInterval = setInterval(() => {
                span.textContent = randomChar();
                scrambleTime += 30;
                if (scrambleTime >= scrambleDuration) {
                    clearInterval(scrambleInterval);
                    span.textContent = originalChar;
                    span.classList.add("visible");
                }
            }, 30);
        }, idx * delayPerChar);
    });
}

// Intersection Observer to trigger animation when in viewport
function animateAllCategoryTitles() {
    const titles = document.querySelectorAll('.category-title-animated');
    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateCategoryTitle(entry.target);
                obs.unobserve(entry.target);
            }
        });
    }, { threshold: 0.2 });

    titles.forEach(title => observer.observe(title));
}

document.addEventListener('DOMContentLoaded', animateAllCategoryTitles);
</script>
<br>

<div style="padding-left:15px;padding-right:15px;" class="view-container">
    <div class="advertise-here">
        <div style="position: relative;height:inherit;width:100%">
            <div class="advert-welcome">
                 Discover new business partners with QM‚Äôs dynamic directory ‚Äî<span style="font-weight: 400;color:rgb(96, 120, 139)"> connect and grow your network today.</span>
            </div>
            <button onclick="window.location.href='/advert_form'" class="advert-btn" >Register</button>
             <img src="{{ url_for('static', filename='icons/add-icon.png') }}" class="close-btn" />
        </div>
    </div>
    <h2></h2>
<!-- Toggle View  -->
<div class="toggle-container">
  <button id="toggle-general" class="toggle-btn" aria-pressed="false">Default</button>
  <button id="toggle-grid" class="toggle-btn" aria-pressed="{{ 'true' if view == 'grid' else 'false' }}"><img src="{{ url_for('static', filename='icons/grid-icon.png') }}" /> <span>Grid</span></button>
  <button id="toggle-list" class="toggle-btn" aria-pressed="{{ 'true' if view == 'list' else 'false' }}"><img src="{{ url_for('static', filename='icons/list-icon.png') }}" /> <span>List</span></button>
</div>

<!-- Grid View  -->
<div style="display: none;" class="grid-view gen-flex">
    {%for company in companies%}
        {%if  company.category%}
        <div data-cid="{{ser.dumps({'cid':company.id})}}" class="company-logos-cards"> 
            <img src="{{ url_for('static', filename='uploads/' + company.logo) }}" class="comp-logos" />
        </div>
        {%endif%}
    {%endfor%}
</div>
<!-- List View  -->
<div style="display: none;" class="list-view gen-flex">
    {%for category in categories%}
        {%if  category%}
        <div style="justify-content: flex-start;" class="gen-flex">
            <img src="{{ url_for('static', filename='icons/category-icon.png') }}" class="cat-icon" />
            <div class="btns">{{ category }}</div>
        </div><br>
        <div class="list-view gen-flex">
            {%for company in companies%}
                {%if category == company.category%}
                    <div class="company-logos-cards"> 
                        <div data-cid="{{ser.dumps({'cid':company.id})}}" style="justify-content: flex-start;" class="list-card gen-flex">
                            <img style="height:80px !important" src="{{ url_for('static', filename='uploads/' + company.logo) }}" class="comp-logos" />
                            <div class="gen-flex-col">
                                <div  class="comp-name">{{company.company_name}} <span style="font-family: Montserrat;color:#868686;font-weight: 500;font-size:16px"> - {{company.country}}</span></div>
                                    
                                {%if company.tagline | length >= 103 %}
                                    <small class="comp_services">{{company.tagline[:103]}}...</small>
                                {%else%}
                                    <small class="comp_services">{{company.tagline}}</small>
                                {%endif%}
                                
                            </div>
                        </div>
                    </div>
                {%endif%}
            {%endfor%}
        </div>
        {%endif%}
    {%endfor%}

    <div style="width:100%;height: 250px;"></div>
</div>
<!-- General View  -->
    {%for category in categories%}
    {%if  category%}
    <div class="category-cont gen-flex sticky-category">
        <img src="{{ url_for('static', filename='icons/category-icon.png') }}" class="cat-icon" />
        <div class="category-title category-title-animated">{{ category }}</div>
        <div style="flex-grow: 1;"></div>
        {% set count = companies | selectattr('category', 'equalto', category) | list | length %}
        <div class="other-cat-info gen-flex"><span>({{ count }})</span></div>
    </div>
    <br>
    <div class="swipe-for-mobile">
        <div style="flex-wrap:wrap;justify-content: flex-start;align-items: stretch;gap:0px" class="gen-flex cards-container" id="cards-container">
            {%for company in companies%}
            {%if category == company.category%}
                {%if company.company_name == "Quick Messanger"%}
                <div style="background-image: url('{{ url_for('static', filename='images/qm_community_bg.gif') }}')" class="business-card gen-flex-col"> 
                    <!-- <div class="overlay"></div>  -->
                    <div style="z-index:5" class="sub-layout-1 gen-flex">
                        <div style="flex-grow: 1;align-items: flex-start;" class="bus-title gen-flex-col">
                            <div class="company-name">{{company.company_name}}</div>
                            {%if company.category %}
                                <label class="category">{{company.category}}</label>
                            {%endif%}

                            <div style="align-items: flex-start;" class="company-details gen-flex-col">
                                {%if company.postal_address %}
                                    <div>{{company.postal_address}}</div>
                                {%endif%}

                                {%if company.company_address%}
                                    <div style="text-align: left;">{{company.company_address[:60]}}</div>
                                {%endif%}

                                {%if company.company_contacts%}
                                    <a href="tel:{{company.company_contacts}}" target="_blank">
                                        <div class="comm-icons-cont gen-flex">
                                            <img src="{{ url_for('static', filename='icons/tel-blue-outline.png') }}" />
                                            <span>{{company.company_contacts}}</span>
                                        </div>
                                    </a>
                                {%endif%}

                                {%if company.email%}
                                    <a href="mailto:{{company.email}}">
                                        <div style="margin-bottom: 7px;" class="comm-icons-cont gen-flex">
                                            <img src="{{ url_for('static', filename='icons/email-blue-outline.png') }}" />
                                            <span>{{company.email}}</span>
                                        </div>
                                    </a>
                                {%endif%}
                            </div>
                        </div>
                        
                    </div>
                    {%if company.image %}
                        <!-- <div class="community-logo"><img src="static\uploads\{{company.logo}}"></div> -->
                    {%endif%}
                    {%if company.tagline %}
                        <div class="tagline tag-in-card"><span style="text-decoration: i;"><i></i></span></div>
                    {%endif%}
                    <div style="z-index:6" style="justify-content: flex-start;" class="links gen-flex">
                        {%if company.website_link %}
                        <a href="{{company.website_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/website-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.facebook_link %}
                        <a href="{{company.facebook_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/facebook-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.instagram_link%}
                        <a href="{{comapny.instagram_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/insta-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.linkedIn_link%}
                        <a href="{{company.linkedIn_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/linkedin-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                    </div>
<!-- style="display: none;" -->
                    <div style="display: none;"  id="msg-icon-mobile" class="imbc-icon">
                        <a id="href_route" href="/compose_mobile?id={{ser.dumps({'data':company.id})}}" target="_blank">
                            <img src="{{ url_for('static', filename='icons/imbc-icon.png') }}" />
                        </a>
                    </div>
                    
                    <div id="msg-icon"  class="imbc-icon">
                        <a id="href_route" href="/compose?id={{ser.dumps({'data':company.id})}}" target="_blank">
                            <img src="{{ url_for('static', filename='icons/imbc-icon.png') }}" />
                        </a>
                    </div>
                    
                </div>
                {%else%}
                <!-- Other Compnaies  -->
                <div style="background-image: url('{{ url_for('static', filename='uploads/' ~ company.logo) }}');" class="business-card gen-flex-col"> 
                    <div class="overlay"></div> 
                    <div style="z-index:5;position:relative" class="sub-layout-1 gen-flex">
                        <div style="flex-grow: 1;align-items: flex-start;" class="bus-title gen-flex-col">
                            <!-- Card Header - Company Name - Logo  -->
                            <div style="align-items: flex-start;" class="bscomm-card-header gen-flex">
                                <div style="justify-content: flex-start;flex-grow:1;">
                                    
                                    <div  class="company-name">{{company.company_name}} <span style="font-family: Montserrat;color:#868686;font-weight: 500;font-size:16px"> - {{company.country}}</span></div>
                                    
                                    {%if company.other2%}
                                        <div style="font-size: 17px;color: #575757;" class="company-name">({{company.other2}})</div>
                                    {%endif%}
                                    {%if company.category %}
                                        <div class="category">{{company.category}}</div>
                                    {%endif%}
                                </div>
                                <div style="justify-self: flex-end;">
                                    <div class="community-logo"><img src="{{ url_for('static', filename='uploads/'+company.logo ) }}"></div>
                                </div>
                            </div>

                            <!-- Contact Details  -->
                            <div style="align-items: flex-start;width: 100%;" class="company-details gen-flex">
                                <div style="justify-content: flex-start;flex-grow:1;align-items: flex-start;" class="gen-flex-col">
                                    {%if company.postal_address %}
                                        <div>{{company.postal_address}}</div>
                                    {%endif%}

                                    {%if company.company_address%}
                                        <div style="text-align: left;">{{company.company_address[:60]}}</div>
                                    {%endif%}

                                    {%if company.company_contacts%}
                                        <a href="tel:{{company.company_contacts}}" target="_blank">
                                            <div class="comm-icons-cont gen-flex">
                                                <img src="{{ url_for('static', filename='icons/tel-blue-outline.png') }}" />
                                                <span>{{company.company_contacts}}</span>
                                            </div>
                                        </a>
                                    {%endif%}

                                    {%if company.email%}
                                        <a href="mailto:{{company.email}}">
                                            <div class="comm-icons-cont gen-flex">
                                                <img src="{{ url_for('static', filename='icons/email-blue-outline.png') }}" />
                                                <span>{{company.email}}</span>
                                            </div>
                                        </a>
                                    {%endif%}
                                </div>
                                <div style="justify-self: flex-end;">
                                
                                    <div style="display: none;"  id="msg-icon-mobile" class="imbc-icon-mobile">
                                        <a id="href_route" href="/compose_mobile?id={{ser.dumps({'data':company.id})}}" >
                                            <img src="{{ url_for('static', filename='icons/imbc-icon.png') }}" />
                                        </a>
                                    </div>
                                    
                                    <div id="msg-icon" style="z-index: 500;" class="imbc-icon">
                                        <a id="href_route" href="/compose?id={{ser.dumps({'data':company.id})}}" target="_blank">
                                            <img src="{{ url_for('static', filename='icons/imbc-icon.png') }}" />
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                    </div>

                    {%if company.tagline %}
                    <div class="tagline tag-in-card"><span style="text-decoration: i;"><i>{{company.tagline}}</i></span></div>
                    {%endif%}
                    <div style="z-index:6" style="justify-content: flex-start;" class="links gen-flex">
                        {%if company.website %}
                        <a href="{{company.website}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/website-outline-icon.png ') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.fb_link %}
                        <a href="{{company.fb_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/facebook-outline-icon.png ') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.instagram_link%}
                        <a href="{{comapny.instagram_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/insta-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                        {%if company.linkedIn_link%}
                        <a href="{{company.linkedIn_link}}" target="_blank">
                            <div class="social-media-cont">
                                <img src="{{ url_for('static', filename='icons/linkedin-outline-icon.png') }}" />
                            </div>
                        </a>
                        {%endif%}
                    </div>
                    


                </div>
                {%endif%}
            {%endif%}
            {%endfor%}   
        </div>
    </div>
    <br><br>
    {%endif%}
    {%endfor%}
</div>

<!-- Company Details Modal -->
<div id="company-modal" class="company-modal">
  <div class="company-modal-content">
    <span class="company-modal-close">&times;</span>
    <div id="company-modal-body">
      <!-- Company details will be loaded here -->
      <div class="company-modal-loading">Loading...</div>
    </div>
  </div>
  <div id="reviews-content" style="display:none;">
    <!-- Reviews will be loaded here -->
    <div class="company-modal-content">
      <span class="company-modal-close">&times;</span>
      <div id="reviews-body">
        <div class="company-modal-loading">Loading reviews...</div>
      </div>
    </div>
  </div>
</div>

<script nonce="{{ nonce }}">

var closeBtn = document.querySelector(".close-btn");
var adContainer = document.querySelector('.advertise-here');
var contanier = document.querySelector('.view-container');

function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    };

closeBtn.addEventListener('click', function(){
    adContainer.style.display = 'none';
    contanier.style.paddingTop = '7px';
});


document.addEventListener('DOMContentLoaded', function() {
    const gridBtn = document.getElementById('toggle-grid');
    const listBtn = document.getElementById('toggle-list');
    const generalBtn = document.getElementById('toggle-general');
    const gridView = document.querySelector('.grid-view');
    const listView = document.querySelector('.list-view');
    const generalViewBlocks = Array.from(document.querySelectorAll('.category-cont, .swipe-for-mobile, br'));

    // var hrefTag = document.querySelector('#href_route');

    // if(window.innerWidth <= 700){
    //     console.log("HREF TAG: ",hrefTag);
    // };

    function setView(view) {
        if (view === 'grid') {
            gridView.style.display = 'flex';
            listView.style.display = 'none';
            gridBtn.setAttribute('aria-pressed', 'true');
            listBtn.setAttribute('aria-pressed', 'false');
            generalBtn.setAttribute('aria-pressed', 'false');
            generalViewBlocks.forEach(el => el.style.display = 'none');
        } else if (view === 'list') {
            gridView.style.display = 'none';
            listView.style.display = 'flex';
            gridBtn.setAttribute('aria-pressed', 'false');
            listBtn.setAttribute('aria-pressed', 'true');
            generalBtn.setAttribute('aria-pressed', 'false');
            generalViewBlocks.forEach(el => el.style.display = 'none');
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'none';
            gridBtn.setAttribute('aria-pressed', 'false');
            listBtn.setAttribute('aria-pressed', 'false');
            generalBtn.setAttribute('aria-pressed', 'true');
            generalViewBlocks.forEach(el => el.style.display = '');
        }
    }

    // Initial state: show general view, hide grid/list
    if(innerWidth <= 700){
        setView('list');
    }else{
        setView('general');
    }
    

    gridBtn.addEventListener('click', function() { setView('grid'); });
    listBtn.addEventListener('click', function() { setView('list'); });
    generalBtn.addEventListener('click', function() { setView('general'); });
});

    
// --- Mobile swipe/scroll for cards-container ---
// document.addEventListener('DOMContentLoaded', function() {
//     var cardsContainers = document.querySelectorAll('.cards-container');
//     cardsContainers.forEach(function(cardsContainer) {
//         function applyMobileScroll() {
//             if (window.innerWidth <= 700) {
//                 cardsContainer.style.flexWrap = 'nowrap';
//                 cardsContainer.style.overflowX = 'auto';
//                 cardsContainer.style.WebkitOverflowScrolling = 'touch';
//                 cardsContainer.style.display = 'flex';
//                 cardsContainer.style.gap = '16px';
//                 cardsContainer.style.scrollBehavior = 'auto'; // Let browser handle smoothness

//                 // Set min-width for cards for better swipe
//                 var cards = cardsContainer.querySelectorAll('.business-card');
//                 cards.forEach(function(card) {
//                     card.style.minWidth = '350px';
//                     card.style.flex = '0 0 auto';
//                 });

//                 // Only attach listeners once
//                 if (!cardsContainer._dragScrollAttached) {
//                     let isDown = false, startX, scrollLeft;

//                     cardsContainer.addEventListener('mousedown', function(e) {
//                         isDown = true;
//                         cardsContainer.classList.add('dragging');
//                         startX = e.pageX - cardsContainer.offsetLeft;
//                         scrollLeft = cardsContainer.scrollLeft;
//                     });
//                     cardsContainer.addEventListener('mouseleave', function() {
//                         isDown = false;
//                         cardsContainer.classList.remove('dragging');
//                     });
//                     cardsContainer.addEventListener('mouseup', function() {
//                         isDown = false;
//                         cardsContainer.classList.remove('dragging');
//                     });
//                     cardsContainer.addEventListener('mousemove', function(e) {
//                         if (!isDown) return;
//                         e.preventDefault();
//                         const x = e.pageX - cardsContainer.offsetLeft;
//                         const walk = (x - startX);
//                         cardsContainer.scrollLeft = scrollLeft - walk;
//                     });

//                     // Touch events
//                     let touchStartX = 0, touchScrollLeft = 0;
//                     cardsContainer.addEventListener('touchstart', function(e) {
//                         if (e.touches.length === 1) {
//                             touchStartX = e.touches[0].clientX;
//                             touchScrollLeft = cardsContainer.scrollLeft;
//                         }
//                     });
//                     cardsContainer.addEventListener('touchmove', function(e) {
//                         if (e.touches.length === 1) {
//                             const x = e.touches[0].clientX;
//                             const walk = (x - touchStartX);
//                             cardsContainer.scrollLeft = touchScrollLeft - walk;
//                         }
//                     });

//                     cardsContainer._dragScrollAttached = true;
//                 }
//             } else {
//                 // Reset to original for desktop
//                 cardsContainer.style.flexWrap = '';
//                 cardsContainer.style.overflowX = '';
//                 cardsContainer.style.WebkitOverflowScrolling = '';
//                 cardsContainer.style.display = '';
//                 cardsContainer.style.gap = '';
//                 cardsContainer.style.scrollBehavior = '';
//                 var cards = cardsContainer.querySelectorAll('.business-card');
//                 cards.forEach(function(card) {
//                     card.style.minWidth = '';
//                     card.style.flex = '';
//                 });
//             }
//         }
//         applyMobileScroll();
//         window.addEventListener('resize', applyMobileScroll);
//     });
// });
    // Function to handle the intersection event
function handleIntersection(entries, observer) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
            // console.log('Element has entered the viewport:', entry.target);
            entry.target.classList.add("show-card");
            // You can add your logic here, for example:
            // entry.target.classList.add('visible'); // Modify the element's class
            // observer.unobserve(entry.target); // Stop observing if you only want to detect once
            }
        });
    }

    // Create an Intersection Observer instance
    const observer = new IntersectionObserver(handleIntersection, {
        root: null, // Use the viewport as the root
        rootMargin: '0px', // No margin
        threshold: 0.8 // Trigger when 10% of the element is in the viewport
    });

    const targetFeatured = document.querySelectorAll('.business-card'); // Adjust the selector as needed

    // Start observing each target element
    targetFeatured.forEach(el => {
        observer.observe(el);
    });


document.addEventListener('DOMContentLoaded', function() {

    // Modal logic
    const modal = document.getElementById('company-modal');
    const modalBody = document.getElementById('company-modal-body');
    const closeBtn = document.querySelector('.company-modal-close');

    // Helper to open modal
    function openModal() {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // Helper to close modal
    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        modalBody.innerHTML = '<div class="company-modal-loading">Loading...</div>';
    }

    closeBtn.onclick = closeModal;
    modal.onclick = function(e) { if (e.target === modal) closeModal(); };
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });
    
    // Attach click listeners to all cards in grid and list
    function attachCardListeners() {
        document.querySelectorAll('.company-logos-cards, .list-card').forEach(function(card) {
            card.onclick = function(e) {
                
                // Find the company logo img inside the card
                let img = card.querySelector('img.comp-logos');
                if (!img) return;
                
                // Get the company logo filename
                let logo = img.getAttribute('src').split('/').pop();
                // Find the company object in JS (optional: you can add a data attribute with company id)
                // Instead, let's use a data-cid attribute for security
                let cid = card.getAttribute('data-cid') || img.getAttribute('data-cid');
                if (!cid) {
                    // fallback: try to get from alt or src
                    return;
                }
                // Show modal and fetch details
                openModal();
                console.log("CID: ", cid);
                fetch('/business_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json','X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ cid: cid })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.company) {
                        modalBody.innerHTML = renderCompanyDetails(data.company,data.follow_status);
                        Listen();
                    } else {
                        modalBody.innerHTML = '<div class="company-modal-loading">No details found.</div>';
                    }
                })
                .catch((err) => {
                    console.log("Error Loading: ", err);
                    modalBody.innerHTML = '<div class="company-modal-loading">Error loading details.  </div>' ;
                });
            };
        });
    }

    function renderCompanyDetails(company,follow_status) {
        modalContent.setAttribute('data-company-id', company.id);
        let tagline = company.tagline || '';
        let follow_descr='Interested üëç'
        if (follow_status) {
            follow_descr = 'Following ‚úî';
        }
        const text = `Check out ${company.company_name} on Quick Messenger!

                    üì¶*Offering:* ${tagline}
                    üìû*Contact:* ${company.company_contacts || ''}
                    üè≠*Address:* ${company.company_address || ''}
                    üñº*Facebook:* ${company.facebook_link || '-'}
                    üåê*Website:* ${company.website_link || '-'}

                    üîó Explore other services here: https://qm.techxolutions.com`;
        wame_tagline = tagline;
        const encodedTagline = encodeURIComponent(tagline);
        const html = `
        <div class="company-modal-body-content">
            <div style="text-align:center;">
                <img class="modal-logo" src="/static/uploads/${company.logo}" alt="${company.company_name} logo">
            </div>
            <h2>${company.company_name || ''}</h2>
            <div class="modal-fields">
                <div class="modal-field"><span class="modal-label"><img src="/static/icons/category-icon.png" alt="Category"></span> ${company.category || ''}</div>
                ${tagline ? `<div class="modal-field" style="font-family:Montserrat;"><i>${tagline}</i></div>` : ''}
                <div class="modal-field" style="font-size:14px;font-weight:500"><span class="modal-label"><img src="/static/icons/location-icon.png" alt="Address"></span> ${company.company_address || ''}</div>
                <div class="modal-field"><span class="modal-label"><img src="/static/icons/tel-blue-outline.png" alt="Contacts"></span> <a href="tel:${company.company_contacts || ''}">${company.company_contacts || ''}</a></div>
                ${company.email ? `<div class="modal-field link-overflow-x"><span class="modal-label"><img src="/static/icons/email-blue-outline.png" alt="Email"></span> <a href="mailto:${company.email}">${company.email}</a></div>` : ''}
                ${company.website_link ? `<div class="modal-field link-overflow-x"><span class="modal-label"><img src="/static/icons/website-outline-icon.png" alt="Website"></span> <a href="${company.website_link}" target="_blank">${company.website_link}</a></div>` : ''}
                ${company.facebook_link ? `<div class="modal-field link-overflow-x"><span class="modal-label"><img src="/static/icons/facebook-outline-icon.png" alt="Facebook"></span> <a href="mailto:${company.facebook_link}">${company.facebook_link}</a></div>` : ''}
            
            </div>
            <div class="gen-flex line-bottom"><img src="static/icons/portfolio-icon.png" style="height:40px;width:40px;" />Work We've Done</div>
            <hr>
            <div class="gen-flex line-bottom"><img src="static/icons/reviews-icon.png" style="height:65px;" /></div>
            <hr>
            <small style="color:#888;font-size:0.9em;font-family:Montserrat;font-size:13px">Get updates on specials, new products and related updates from ${company.company_name} tailoured for you?</small>
            <div style="padding-bottom:9px" data-uid={{current}} data-cid=${company.id} id="follower-trigger" class="lead-gen-icons btns gen-flex"><span>${follow_descr}<span></div>
            <hr>
            <a href="https://wa.me/?text=${company.company_name} %0A%0A ${encodedTagline}%0A%0AüìûContact: ${company.company_contacts || ''}%0Aüè≠Address: ${company.company_address || ''}%0Aüë®‚Äçüëß‚ÄçüëßFacebook: ${company.facebook_link || '-'}%0AüåêWebsite: ${company.website_link || '-'}%0A%0AThis business profile is shared via Quick Messanger, dynamically : %0Aüîó Explore Quick Messanger, register and boost your brand awareness here: https://qm.techxolutions.com"   target="_blank" rel="noopener noreferrer">
                <img style="height:50px;width:50px" src="static/icons/whatsapp-col-icon.png" /> <span> Share on WhatsApp</span>
            </a><br><br><br><br><br>
        </div><br>
        `;
        return html;
        
    }

        function Listen() {
            const el = document.getElementById('follower-trigger');
            if (!el) return;

            el.addEventListener('click', function () {
                const userId = this.getAttribute('data-uid');
                const companyId = this.getAttribute('data-cid');
                followCompany(userId, companyId);
            });
        }


    function followCompany(uid,cid) {
        // const uid = document.getElementById('follower-trigger').getAttribute('data-uid') || '';
        const data = { uid: uid, cid: cid };
        fetch('/follow_company', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-CSRFToken': getCSRFToken() },
            body: JSON.stringify(data)
        })
        .then(resp => resp.json())
        .then(resp => {
                document.getElementById('follower-trigger').innerHTML = '<div style="padding-bottom:9px" id="follower-trigger" class="lead-gen-icons btns gen-flex"><span>Following ‚úî<span></div>';
           
                console.log(resp.msg || 'Error following company.');

        })
        .catch(() => {
            console.log('caught Error following company.');
        });
    }


    // Add data-cid attribute to each card for secure lookup
    function addCidToCards() {
        
        document.querySelectorAll('.company-logos-cards, .list-card').forEach(function(card) {
            // Only add if not already present
            if (!card.getAttribute('data-cid')) {
                // Try to get from child img
                let img = card.querySelector('img.comp-logos');
                if (img && img.hasAttribute('data-cid')) {
                    card.setAttribute('data-cid', img.getAttribute('data-cid'));
                }
            }
        });
    }

    addCidToCards();
    attachCardListeners();


    // Reviews Section 
    const reviewsBtnSelector = '.gen-flex img[src*="reviews-icon"]';
    const reviewsBtn = document.querySelector(reviewsBtnSelector)?.parentElement;
    const modalContent = document.querySelector('.company-modal-content');
    const reviewsContent = document.getElementById('reviews-content');
    const reviewsBody = document.getElementById('reviews-body');

    // Show reviews section
    function showReviews(companyId) {
        modalContent.style.display = 'none';
        reviewsContent.style.display = 'block';
        reviewsBody.innerHTML = '<div class="company-modal-loading">Loading reviews...</div>';
        // Fetch reviews from backend
        fetch('/get_reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ company_id: companyId })
        })
        .then(resp => resp.json())
        .then(data => {
            reviewsBody.innerHTML = renderReviews(data.reviews || []);
        })
        .catch(() => {
            reviewsBody.innerHTML = '<div class="company-modal-loading">Error loading reviews.</div>';
        });
    }

    // Hide reviews and show details
    function hideReviews() {
        reviewsContent.style.display = 'none';
        modalContent.style.display = 'block';
    }

    // Attach to reviews button
    document.addEventListener('click', function(e) {
        if (e.target.closest(reviewsBtnSelector)) {
            const companyId = modalContent.getAttribute('data-company-id');
            showReviews(companyId);
        }
        if (e.target.closest('#reviews-content .company-modal-close')) {
            hideReviews();
        }
    });

    // When rendering company details, set data-company-id for later use
    // function renderCompanyDetails(company) {
    //     modalContent.setAttribute('data-company-id', company.id);
    //     // ...existing code...
    // }

    // Render reviews (stars + comments)
    function renderReviews(reviews) {
        if (!reviews.length) return '<div>No Customer reviews yet.</div>';
        return reviews.map(r => `
            <div style="margin-bottom:18px;">
                <div>${renderStars(r.rating)}</div>
                <div style="font-size:1em;color:#333;margin-top:4px;">"${r.comment}"</div>
                <div style="font-size:0.9em;color:#888;">- ${r.customer_name || 'Anonymous'}</div>
            </div>
        `).join('');
    }
    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span style="color:${i <= rating ? '#EF4036' : '#ccc'};font-size:1.3em;">&#9733;</span>`;
        }
        return stars;
    }
});

</script>
<!-- </html> -->
{%endblock%}