

{% extends "base.html" %}
{% block content %}
<div style="position: relative;" class="container form-container">
  <label>Login</label><br>
  <h2 style="color:#EF4036">Login Details</h2>
    <br>
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for  category, message in messages %}
                    <div id="alert-{{category}}" class="flash-messages alert-{{category}}"> {{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
  <form class="form" method="post" action="">
    {{form.hidden_tag()}}
     <div class="group">
        <div class="acc-labels">{{ form.email.label(class="labels")}}</div>
        {{ form.email(class="form-control",placeholder="Your email")}}
        {% if form.email.errors %}
        {% for error in form.email.errors %}
            <span class="span-error" >*{{error}}</span>
        {% endfor %}
        {% endif %}
    </div>
    <div class="group">
        <div class="acc-labels">{{ form.password.label(class="labels")}}</div>
        {{ form.password(class="form-control",placeholder="Password")}}
        {% if form.password.errors %}
        {% for error in form.password.errors %}
            <span class="span-error" >*{{error}}</span>
        {% endfor %}
        {% endif %}
    </div>
    
    <div style="width:100% !important;" class="flex d-flex flex-row align-items-center justify-content-between">
        {{ form.submit(class="btns",id="loginBtn") }}
    </div>
    <div class="group d-flex flex-row align-items-center justify-content-between">
        <a href="/register" style="color:#3667ef;font-weight: 600;">Signup instead?</a>
        <a href="/password_reset_req" style="color:#4f4f50;font-weight: 400;margin-left:20px;text-decoration: underline;">Forgot Password</a>
    </div>
    <br>
    
</form>
<img style="position: absolute;right:15px;top:25px;height:90px" src="static/icons/imbc-icon.png" />
</div>

<script nonce="{{ nonce }}">


let db_ind;
window.addEventListener("DOMContentLoaded", async function(){
  var companyInput = document.querySelector("#company_name");
  var companyChoice = document.getElementById("register-company");

    if(window.innerWidth <= "700"){
        companyInput.required = false;
        companyInput.style.display = "none";

        companyChoice.addEventListener("change", function() {
            if (companyChoice.checked) {
                companyInput.required = true;
                companyInput.style.display = "block";
            } else {
                companyInput.required = false;
                companyInput.style.display = "none";
            }
        });

    };

    
    const loginBtn = document.querySelector("#loginBtn");
    const flashError = document.querySelector("#alert-error");
    const attemptKey = "loginAttempts";
    const blockKey = "loginBlockUntil";
    const maxAttempts = 5;
    const blockDuration = 60 * 60 * 1000; // 60 mins

    const now = Date.now();
    const blockUntil = localStorage.getItem(blockKey);

    const messageDiv = document.createElement("div");
    messageDiv.style.marginTop = "10px";
    loginBtn.parentNode.insertBefore(messageDiv, loginBtn.nextSibling);

    // If currently blocked
    if (blockUntil && now < parseInt(blockUntil)) {
        const secondsLeft = Math.ceil((parseInt(blockUntil) - now) / 1000);
        blockLogin(secondsLeft);
        return;
    }

    // If login just failed
    if (flashError) {
        let attempts = parseInt(localStorage.getItem(attemptKey)) || 0;
        attempts += 1;
        localStorage.setItem(attemptKey, attempts);
        console.log("Attempts");
        if (attempts >= maxAttempts) {
            const newBlockUntil = now + blockDuration;
            localStorage.setItem(blockKey, newBlockUntil);
            localStorage.removeItem(attemptKey); // reset
            blockLogin(blockDuration / 1000);
        } else {
            const remaining = maxAttempts - attempts;
            messageDiv.innerText = `âš ï¸ You have ${remaining} login attempt${remaining > 1 ? "s" : ""} left.`;
            messageDiv.style.color = "orange";
        }
    }

    // Function to show countdown & disable button
    function blockLogin(seconds) {
        if (loginBtn) loginBtn.disabled = true;
        let remaining = seconds;

        const interval = setInterval(() => {
            messageDiv.innerText = `ðŸš« Too many login attempts. Try again in ${formatTime(remaining)}.`;
            messageDiv.style.color = "red";
            remaining--;

            if (remaining <= 0) {
                clearInterval(interval);
                loginBtn.disabled = false;
                messageDiv.innerText = "";
                localStorage.removeItem(blockKey);
                localStorage.removeItem(attemptKey);
            }
        }, 1000);
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}m ${s}s`;
    }
    
});

window.addEventListener('load', async function(){

    // console.log("SaveIs Called: ");
    var userLabel =document.querySelector("#username-label");

    if (userLabel){
        initDB().then((db) =>{
            console.log("db", db.objectStoreNames.contains("keys"));
        });
        // window.location.href = "/";
    }else{
        // initialise DB 
        initDB().then((db) =>{
            console.log("db", db.objectStoreNames.contains("keys"));
           register();
        });
    }
    

    
});


</script>
{% endblock %}