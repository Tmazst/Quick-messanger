<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-16">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Quick Messanger (QM) allows companies and professionals across the globe to connect, exchange messages,and share business information in a both private & public, organized environment.">
    <meta name="key words" content="Quick Messanger (QM) is a secure, fast and reliable business communication and networking platform.">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Oswald:300,400,700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" type="text/css" href="static/css/styles.css" />
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bs_stylesheet.css') }}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <meta name="theme-color" content="#EF4036"/>
    <link rel="icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
    <link rel="icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
    <link rel="icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/512x512.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/512x512.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/512x512.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <title>Quick Messager - Business Connect</title>
    <link rel="icon" type="image/png" href="static/icons/rel_link_icon.png">

    <div class="topbar">
        <div class="top-bar-left">
            <img id="main-logo" src="{{ url_for('static', filename='images/logo-white.png') }}" alt="Logo" class="logo">
        </div><div style="flex-grow:1"></div>
        <div class="top-bar-right gen-flex">
            <!-- <a href="/download_pwa" class=""> -->
            <div style="display: none;" class="app-dowload-container gen-flex">
                <div class="app-download-icon gen-flex">
                    <button id="pwa-install-btn" class="top-bar-link pwa-install-btn gen-flex"><img src="{{ url_for('static', filename='icons/download-pwa-icon.png') }}" alt="Download App" class="app-download-icon-img"> <span>Install Quick Messanger</span></button>
                </div>
            </div>
            <!-- </a> -->
            <!-- <a href="/subscribe" class="top-bar-link ">Subscribe</a> -->
        </div>
        <button id="register-mobile" onclick="window.location.href='/register'" class="btns">Register</button>
    </div>
    <style nonce="{{ nonce }}">
        .nav-message-text{
            font-family: "Montserrat", "Arial", "Helvetica Neue", Helvetica, sans-serif !important;
            font-size: 13px !important;
            width: 100%;
        }
        .active-tab{
            margin-right:-20px;
            border-left: 3px solid #EF4036 !important;
            border-bottom-right-radius: 0;
            border-top-right-radius: 0;
            background-color: #f1f1f1 !important;

        }
        .active{
            color:#EF4036 !important;
            background: none !important;
        }
        .mobile-bottom-navigation{
            position: absolute;
            bottom: 0;
            left:0;
            width:100%;
            background: rgba(255,255,255,0.2) !important;
            backdrop-filter: blur(5px) !important;
            gap:0 !important;
            z-index: 2000;
        }
        .mobile-bottom-navigation a{
            color:white;
            padding:10px 10px;
            background-color: #f89b96;
        }
        #first-btn{
            border-top-left-radius: 14px;
            /* border-right: 1px solid #c23129; */
        }
        #last-btn{
            border-top-right-radius: 14px;
            border-left: 1px solid #f89b96;
        }
        
    </style>
<!-- <button class="menu burger">Menu</button> -->
</head>
<body>
    <!-- <div class="spacer-mobile" style="display:none;width:100%;height: 50px;"></div> -->
    {% block replyunit%}
    {%endblock%}
    {% block about%}
    {%endblock%} 
    <!-- <button style="z-index:1900;display:none" onclick="openQMenu()" id="quick-menu-btn">Q-Menu</button> -->
    <!-- <div style="display: none;z-index:1900;width:max-content" id="download-icon-" class="app-nav-icons gen-flex">
        <img src="{{ url_for('static', filename='icons/download-pwa-icon.png') }}" alt="Logo" class="app-nav-icon">
        <small style="color:white">Install App</small>
    </div> -->
    <div style="display:none;justify-content: flex-start;flex-wrap: nowrap;" class="mobile-nav-bar gen-flex">
        <div style="display:none;" id="menu-icon-mobile" onclick="toggleMenu()" class="menu-icon-mobile">
            <div style="height: 3px;" class="stroke-mobile"></div>
            <div style="height: 3px;" class="stroke-mobile"></div>
            <div style="height: 3px;" class="stroke-mobile"></div>
        </div>
        <div style="flex-grow:1"></div>
        <div id="user-account-mb-cont" class="user-cont-mobile">
            {%if current_user.is_authenticated%}
                <button id="login-mobile"  class="btns">{{current_user.name}}</button>
                <div id="user-modal-mobile" class="user-modal-mobile gen-flex-col">
                    <div class="user-modal-header gen-flex-col">
                        <img src="{{ url_for('static', filename='uploads/'+ usr_obj.image) }}" alt="Logo" class="username-icon-in-modal">
                        
                        <span class="user-modal-title">{{current_user.name}}</span>
                    </div>
                    <a href='/user_account' class="btns gen-flex">Account</a>
                    <a href='/logout' id="logout-button" class="btns gen-flex user-links" >Logout</a>
                </div>
            {%else%}
                <button id="login-mobile" onclick="window.location.href='/manual_login'" class="btns">login</button>
            {%endif%}
        </div>
        
    </div>
    <div style="justify-content: flex-start;padding-top:20px;display: none;" class="mobile-menu gen-flex-col">
        <div class="mobile-menu-header gen-flex-col">
            <img src="{{ url_for('static', filename='images/logo-icon-white.png') }}" alt="Logo" class="mobile-menu-logo">
            <span style="color:#f1f1f1" class="mobile-menu-title">Quick Messanger</span>
        </div>
        <div  class="mobile-menu-links gen-flex-col">
            <a href="/"><div class="mobile-menu-link">Home</div></a>
            <a href="/business_community"><div class="mobile-menu-link">Business Community</div></a>
            <a href="/adverts"><div class="mobile-menu-link">Adverts</div></a>
            <a href="/news"><div class="mobile-menu-link">Business Buzz</div></a>
            <a href="/digital_marketing"><div class="mobile-menu-link">Digital Marketing</div></a>
            {%if current_user.is_authenticated and current_user.company_id[0].company_name %}
                <a href="/company_account"><div class="mobile-menu-link">Company Details</div></a>
            {%else%}
                <a href="/user_account"><div class="mobile-menu-link">Account</div></a>
            {%endif%}
            <a href="/about"><div class="mobile-menu-link">Info</div></a>
            <a href="/pricing"><div class="mobile-menu-link">Payment Plans</div></a>
            {%if current_user.is_authenticated%}
            <a href="/compose"><div class="mobile-menu-link">Compose</div></a>
            {%endif%}
        </div>
        <img src="{{ url_for('static', filename='icons/add-icon.png') }}" onclick="toggleMenu()" alt="close" class="mobile-menu-close">
    </div>


    <div id="global-loader" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(255,255,255,0.85);align-items:center;justify-content:center;flex-direction:column;">
        <div style="margin-bottom:20px;">
            <svg width="60" height="60" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#EF4036" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)">
                    <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/>
                </circle>
            </svg>
        </div>
        <div style="font-family:Montserrat,sans-serif;font-size:1.2em;color:#EF4036;">Please wait...</div>
        <div style="height:100px;width:100%"></div>
        <div style="font-family:Montserrat,sans-serif;font-size:14px;color:#686767;font-weight: bold; padding: 0 20px;" class="gen-flex-col">
            <span>Proudly Sponsored by</span>
            <img src="static/icons/sponsor-icon.png" style="height: 45px;" alt="sponsor-logo" /> 
        </div>
    </div>
   
    <!-- Mobile Quick Menu  -->
    <div style="display:none" class="mobile-quick-menu gen-flex-col">
        <img class="quick-me-logo" src="static/images/logo-icon-white.png" />
        <!-- <div class="gen-flex"><img class="quick-esw-logo" src="static/images/eswatini_flag.png" />
        <div style="color:#5a5a5a;text-shadow: #919191;">QM - Eswatini</div></div> -->
         <h1 style="margin-top:-10px;color:#EF4036;text-shadow: #919191;">Quick Menu</h1>
        <div class="gen-flex">
            <div id="link-1"  onclick="window.location.href='/business_community'" class="side-nav-item gen-flex">
                <img src="static/icons/business-comm-icon.png" />
                <div  class="link-title gen-flex-col">
                    <span class="nav-link" >Business Community</span>
                    <!-- <small>Find Small, Big Enteprises</small> -->
                </div>
            </div>
            <div id="link-1"  onclick="window.location.href='/reply_unit'" class="side-nav-item gen-flex">
                <img src="static/icons/qm-messaging-icon.png" />
                <div  class="link-title gen-flex-col">
                    <span class="nav-link" >Inbox</span>
                    <!-- <small>Responses for Equiries</small> -->
                </div>
            </div>
        </div>
        <div class="gen-flex">
            <div id="link-2" onclick="window.location.href='/adverts'" class="side-nav-item gen-flex">
                <img src="static/icons/advert-icon.png" />
                <div class="link-title gen-flex-col">
                    <span class="nav-link" href="">Adverts</span>
                    <!-- <small>Explore products and services</small> -->
                </div>
            </div>
            <div id="link-3" onclick="window.location.href='/company_stories'" class="side-nav-item gen-flex">
                <img src="static/icons/business-news-icon.png" />
                <div class="link-title gen-flex-col">
                    <span class="nav-link" >Companies</span>
                    <span class="nav-link" >News & Events</span>
                    <!-- <small>Explore Business Statuses</small> -->
                </div> 
            </div>
        </div>
        <button onclick="closeQMenu()" class="qm-exit">Exit</button>
    </div>

    <div id="notification-container" class="notification-container"></div>
    <!-- Login Modal (hidden by default) -->
    <div style="z-index: 2000;" id="alert-confirm" class="login-modal-bg gen-flex-col">
        <div style="justify-content: flex-start;" class="login-modal gen-flex-col">
            <div>Welcome:</div>
            <div id="user-name"></div>
            <a id="login"><div class="btns gen-flex">Continueüëç</div></a>
            <a id="go-register" style="display: none;" ><div onclick="window.location.href='/register'" class="btns gen-flex">Register</div></a>
        </div>
    </div>

    <!-- Recovery Modal (hidden by default) -->
    <div id="recovery-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; max-width:400px; margin:auto;">
            <h2 style="color:#EF4036">Backup Your Account</h2>
            <p>Save your recovery file and key below. You will need them to restore your account if you lose access.</p>
            <div><br>
            <b>1. Recovery Key:</b>
            <div id="recovery-key" style="font-family:monospace; font-size:1.2em; margin:0.5em 0;"></div>
                <button class="btns"  id="copy-recovery-key">Copy Key</button>
            </div><br><br>
            <div><b>2. Save Recovery File:</b></div><br>
            <div><button class="btns" id="download-recovery-file">Download Recovery File</button></div>
            
            <br><br>
            <button style="padding:7px;border-radius: 15px;background: rgb(50, 50, 250);" class="btns"  onclick="closeRefresh()">Continue</button>
        </div>
    </div>

    <!--Auto Recovery Modal Save (hidden by default) -->
    <div id="auto-recovery-modal-sv" style="display:none; position:fixed; top:20px; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; max-width:400px; margin:auto;">
            <h2 style="color:#EF4036">Backup Your Account</h2>
            <p>We are creating a backup of your encryption keys incase you lose your account or change devices.</p>
            <div><br>
            <b>Enter Password:</b>
            <div id="recovery-key" style="font-family:monospace; font-size:1.2em; margin:0.5em 0;"></div>
                <input type="password" class="form-control" name="password-rec" id="password-rec-id-sv" />
            </div>

            <br><br>
            <small id="error-field-sv" style="color:red"></small>
            <div><button onclick="AutoSaveKeys()" class="btns call-loader" id="download-recovery-file">Create Backup</button></div>
            <br><br>
        </div>
    </div>

    <!--Auto Recovery Modal (hidden by default) -->
    <div id="auto-recovery-modal" style="display:none; position:fixed; top:20px; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; max-width:400px; margin:auto;">
            <h2 style="color:#EF4036;font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;">Recover Account Keys</h2>
            <p style="font-size:13px;font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;">Your account is found but your security keys were not found from the database. 
                This means that you will not be able to read messages sent by your customers and partners. <br> Enter password to restore your keys automatically or skip and do it later.</p>
            <div><br>
            <b>Enter Password:</b>
            <div id="recovery-key" style="font-family:monospace; font-size:1.2em; margin:0.5em 0;"></div>
                <input type="hidden" name="username-rec" id="username-rec-id" value="{{current}}" />
                <input type="password" class="form-control" name="password-rec" id="password-rec-id" />
            </div>
            <small id="error-field" style="color:red"></small>
            <br><br>
            <small id="error-field" style="color:red"></small>
            <div class="gen-flex" style="justify-content: space-between;">
                <div><button onclick="autoRecoverKeys()" class="btns" id="download-recovery-file">Restore</button></div>
                <div style="cursor: pointer;margin-top: 4px;color: rgb(4, 137, 214);" onclick="skipRecovery()" id="skip-now">Skip for now</div>
            </div><br>
            <div style="margin-top:10px;">
                <small style="color:#EF4036">If you do not remember your password, please contact support or create new keys.</small>
            </div>
            <div><button onclick="registerNewKeys()" style="background-color: #5a5a5a;" class="btns call-loader" id="download-recovery-file">Create News Keys</button></div><br>
            <br><br>
        </div>
    </div>
    <!-- Legacy Recovery Modal  -->
    <div id="restore-modal" style="display:none; position:fixed; top:0;left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; max-width:400px; margin:auto;">
            <h2>Restore Your Account</h2>
            <input type="file" id="recovery-file-input" accept=".json" /><br><br>
            <input type="text" id="restore-key-input-legacy" placeholder="Enter your recovery key" style="width:100%;" /><br><br>
            <button id="restore-account-btn">Restore</button>
            <div id="restore-status" style="color:red; margin-top:1em;"></div>
            <br>
            <button onclick="closeRecModal()" class="btns">Close</button>
        </div>
    </div>
    <!-- Install PWA Modal Prompt  -->
    <div id="pwa-install-modal" style="display:none; position:fixed; bottom:20px; left:0; right:0; margin:auto; max-width:320px; background:#fdf4f4; border-radius:10px; box-shadow:0 2px 10px #0002; z-index:9999; padding:20px; text-align:center;border:1px solid #EF4036">
        <h3 style="color:#EF4036">Install Quick Messanger App</h3>
        <p style="color:#3f3f3f">Get a faster, app-like experience on your phone. Install now!</p>
        <button class="btns" id="pwa-install-btn2" style="margin:10px 0;">Install App</button>
        <button id="pwa-dismiss-btn" style="background:none; border:none; color:#888; font-size:1.2em;">Dismiss</button>
    </div>
    <!-- Push Notification Subscription Modal -->
    <div id="push-subscribe-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; max-width:400px; margin:auto; text-align:center;">
            <h3 style="color:#EF4036">Enable Notifications</h3>
            <p style="color:#3f3f3f">Stay updated about Businesses in Eswatini! Allow notifications from Quick Messenger.</p>
            <button class="btns" onclick="subscribeToPush()">Allow Notifications</button>
            <button onclick="document.getElementById('push-subscribe-modal').style.display='none'">Dismiss</button>
        </div>
    </div>

    <div style="width:100%  !important;gap:0" class="gen-flex navigation-main">
        <!-- Main App Navigation Bar  -->
        <div style="padding-top:60px" class="app-nav-bar-left">
            <div  onclick="openMenuFunc()" class="side-menu-icon">
                <div class="side-menu-stroke"></div>
                <div class="side-menu-stroke"></div>
                <div class="side-menu-stroke"></div>
            </div><br>
            <a href="/"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/home-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Home</div>
            </div></a>
            <a href="/digital_marketing"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/digital-marketing-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Digital marketing</div>
            </div></a>
            <a href="/company_account"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/profile-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Account</div>
            </div></a>
            <a href="/about"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/info-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Info</div>
            </div></a>
            <a href="/pricing"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/subscriptions-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Payment Plans</div>
            </div></a>
            <div style="display: none;" id="download-icon-2" class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/download-pwa-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Install App</div>
            </div>
            <a href="/qm_partnership"><div class="app-nav-icons gen-flex">
                <img src="{{ url_for('static', filename='icons/partnership-icon.png') }}" alt="Logo" class="app-nav-icon">
                <div class="nav-label">Partnership Programs</div>
            </div></a>
            {%if current_user.is_authenticated%}
            <div style="" id="open-reply-unit"  class="app-nav-icons gen-flex">
                <img  style="height:32px" src="static/icons/mini-window.png" class="app-nav-icon" />
                <div class="nav-label">Open mini-window</div>
            </div>
            {%endif%}
            
        </div>

        <!-- Container for Chats Nav & Content Section  -->
        <div style="gap:0px;" class="left-main gen-flex">
            <!-- Chats & App Navigation  -->
            <div class="left-side-section-container">
                <div class="side-section gen-flex-col">
                    <!-- <a href="/compose"> -->
                        <div onclick="window.location.href='/compose'" style="justify-content: flex-start;cursor: pointer;" class="compose-message gen-flex">
                            <div class="compose-message-icon gen-flex"><img src="{{ url_for('static', filename='icons/compose-icon.png') }}" alt="icon" class="compose-message-icon"></div>
                            <span class="compose-message-label">Compose</span>
                        </div>
                    <!-- </a> -->

                    <div class="side-navbar-nav gen-flex-col">
                        <!-- Messages Button  -->
                        <div id="navlink-message" class="side-nav-item active gen-flex-col">
                            <div style="justify-content: flex-start !important; width: 100%;" class=" gen-flex">
                                <img src="static/icons/qm-messaging-icon.png" />
                                <div style="align-items: flex-start;" onclick="openAndCloseMsgs(event)" class="link-title gen-flex-col">
                                    <span class="nav-link" >Messages</span>
                                    <small>Inbox Messages</small>
                                </div>
                            </div>
                            {% for msg in messages %}
                                    {%set my_msgs = msg.key%}
                                    {%if current == my_msgs and not msg.sender == current%}
                                        <div class="messages-count gen-flex"><span>{{loop.index}}</span></div>
                                    {%endif%}
                            {%endfor%}
                            <div class="scorllable-messages gen-flex-col">
                                
                                <div class="messages-container">
                                    {% for msg in messages %}
                                    <!-- If user not authenticated especially customers who are not yet signed up  -->
                                    {%if msg.phone or msg.cust_email %}
                                        {%if msg.receiver == current%}
                                            <!--received messages-->
                                            <div onclick="window.location.href='/get_messages?phone={{msg.phone}}&key={{msg.key}}'" id="messages-inbox-cont" data-phone="{{msg.phone}}"  class="message-item gen-flex-col">
                                                <!-- Name, Logo, and Time  -->
                                                <div class="message-item-header-left gen-flex">
                                                    <div  class="message-item-header-left gen-flex">
                                                        <img src="{{ url_for('static', filename='images/default') }}" alt="Logo" class="message-item-icon">
                                                        {% if msg.sender | length >= 12 %}
                                                            <span class="message-item-name">{{ msg.sender[:12] }}...</span>
                                                        {% else %}
                                                            <span class="message-item-name">{{ msg.sender }}</span>
                                                        {% endif %}
                                                        <div class="inbox-icon">inbox</div>
                                                    </div>
                                                </div>
                                                <!-- Message Caption  -->
                                                {%if msg.message | length >= 20 %}
                                                    <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message[:20] }}...</div>
                                                {% else %}
                                                    <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message }}</div>
                                                {% endif %}
                                                <span class="message-item-time">{{msg.date.strftime("%d %b %H:%M" )}}</span>
                                            </div>
                                        {%endif%}
                                    {%else%}
                                    <!-- If user is_authenticated especially from a registered company  -->
                                    {%set the_sender = msg.sender%}
                                        {%set my_msgs = msg.key%}
                                        {%if current == my_msgs%} 
                                                    {%if msg.sender == current%}<!--sent messages-->
                                                    {%set rec_usrnm = usrn.query.filter_by(username=msg.receiver).first()%}
                                                    <div onclick="window.location.href='/get_messages?phone={{msg.phone}}&key={{rec_usrnm.username}}'" id="messages-inbox-cont"  class="message-item gen-flex-col">
                                                        <!-- Name, Logo, and Time  -->
                                                        <div  class="message-item-header-left gen-flex">
                                                            <div onclick="window.location.href='/get_messages?key={{rec_usrnm.username}}'" class="message-item-header-left gen-flex">
                                                                {% set name = rec_usrnm.user_details[0].name %}
                                                                {%if rec_usrnm.company_details[0].company_name  %}
                                                                    <img src="{{ url_for('static', filename='uploads/'+ rec_usrnm.company_details[0].image) }}" alt="Logo" class="message-item-icon">
                                                                {%else%}
                                                                    <img src="{{ url_for('static', filename='uploads/'+ rec_usrnm.user_details[0].image) }}" alt="Logo" class="message-item-icon">
                                                                {%endif%}
                                                                {% if name | length >= 12 %}
                                                                    <span class="message-item-name">{{ name[:12] }}...-</span>
                                                                {% else %}
                                                                    <span class="message-item-name">{{ name }}-</span>
                                                                {% endif %}
                                                                <div id="sent-icon" class="inbox-icon">Sent</div>
                                                            </div>
                                                        </div>
                                                            <!-- Message Caption  -->
                                                            {%if msg.message | length >= 20 %}
                                                                <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message[:20] }}...</div>
                                                            {% else %}
                                                                <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message }}</div>
                                                            {% endif %}
                                                            <span class="message-item-time">{{msg.date.strftime("%d %b %H:%M" )}}</span>
                                                        
                                                    </div>
                                                            
                                                    {%elif msg.receiver == current%}<!--received messages-->
                                                    {%set send_usrnm = usrn.query.filter_by(username=msg.sender).first()%}
                                                    <div onclick="window.location.href='/get_messages?phone={{msg.phone}}&key={{send_usrnm.username}}'" id="messages-inbox-cont"  class="message-item gen-flex-col">
                                                        <!-- Name, Logo, and Time  -->
                                                        <div class="message-item-header-left gen-flex">
                                                            <div  class="message-item-header-left gen-flex">
                                                                
                                                                {% set name = send_usrnm.user_details[0].name %}
                                                                {%if send_usrnm.company_details[0].company_name  %}
                                                                    <img src="{{ url_for('static', filename='uploads/'+ send_usrnm.company_details[0].image) }}" alt="Logo" class="message-item-icon">
                                                                {%else%}
                                                                    <img src="{{ url_for('static', filename='uploads/'+ send_usrnm.user_details[0].image) }}" alt="Logo" class="message-item-icon">
                                                                {%endif%}
                                                                {% if name | length >= 12 %}
                                                                    <span class="message-item-name">{{ name[:12] }}...++</span>
                                                                {% else %}
                                                                    <span class="message-item-name">{{ name }}++</span>
                                                                {% endif %}
                                                                <div class="inbox-icon">inbox</div>
                                                            </div>
                                                        </div>
                                                            <!-- Message Caption  -->
                                                            {%if msg.message | length >= 20 %}
                                                                <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message[:20] }}...</div>
                                                            {% else %}
                                                                <div data-encrypted="{{msg.message}}" class="nav-message-text">{{ msg.message }}</div>
                                                            {% endif %}
                                                            <span class="message-item-time">{{msg.date.strftime("%d %b %H:%M" )}}</span>
                                                        
                                                    </div>
                                                    {%else%}
                                                    <div class="message-item-header-left gen-flex">
                                                        <i>No Messages</i>
                                                    </div>
                                                    {%endif%}
                            
                                                <div class="filler"></div>
                                                
                                            <!-- </div> -->
                                            
                                        <!-- </div> -->
                                        {%endif%}
                                    {%endif%}
                                    {% endfor %}

                                </div>
                            </div>
                        </div>
                        
                        <div id="link-1"  onclick="window.location.href='/business_community'" class="side-nav-item gen-flex">
                            <img src="static/icons/business-comm-icon.png" />
                            <div  class="link-title gen-flex-col">
                                <span class="nav-link" >Business Community</span>
                                <small>Network Pool - Find New Partners</small>
                            </div>
                        </div>
                        <div id="link-2" onclick="window.location.href='/adverts'" class="side-nav-item gen-flex">
                            <img src="static/icons/advert-icon.png" />
                            <div class="link-title gen-flex-col">
                                <span class="nav-link" href="">Adverts</span>
                                <small>Advertise & Promote to the World</small>
                            </div>
                        </div>
                        <div id="link-3" onclick="window.location.href='/company_stories'" class="side-nav-item gen-flex">
                            <img src="static/icons/business-news-icon.png" />
                            <div class="link-title gen-flex-col">
                                <span class="nav-link" >Companies News & Events</span>
                                <small>Share your company‚Äôs status</small>
                            </div>
                        </div>
                        <!-- Sponsor Advertising Frame  -->
                         <!-- <div class="sponsor-ads-frame">

                         </div> -->
                    </div>
                </div>
            </div>
            <!-- Content Section  -->
            <div class="right-side-section-container">
                <!-- Profile Bar  -->
                <div style="justify-content: flex-start;" class="sub-titles gen-flex">
                    {%if company.image %}
                    <img onclick="window.location.href='/company_account'" src="{{ url_for('static', filename='uploads/'+ company.image) }}" alt="Logo" class="sub-title-logo">
                   {%endif%}
                    <span onclick="window.location.href='/company_account'" style="" id="company-title" style="font-size:18px;font-weight:500">{{company.company_name}}</span>
                    <div class="flash-messages">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for  category, message in messages %}
                                    <div class="flash-messages alert-{{category}}"> {{ message }}</div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div id="active-tab-desc" class="filler gen-flex">  </div>
                    {%if current%}
                    <div id="user-button" class="username gen-flex" style="cursor: pointer;">
                        <div class="username-icon-cont gen-flex">
                            {%if usr_obj.image %}
                            <img src="{{ url_for('static', filename='uploads/'+ usr_obj.image) }}" alt="username" class="username-icon">
                            {%endif%}
                        </div>
                        <span id="username-label">{{usr_obj.name}}</span>
                        <div style="position: absolute;z-index: -2;" id="cuser-ref">{{current}}</div>
                        
                        <div  class="user-modal gen-flex-col">
                            <div class="user-modal-header gen-flex-col">
                                <img src="{{ url_for('static', filename='uploads/'+ usr_obj.image) }}" alt="Logo" class="username-icon-in-modal">
                               
                                <span class="user-modal-title">{{usr_obj.name}}</span>
                            </div>
                            <a href='/user_account' class="btns">Account</a>
                            <a href='/logout' id="logout-button" class="btns user-links" >Logout</a>
                        </div>
                    </div>
                    {%else%}
                    <div style="position: absolute;z-index: -2;" id="cuser-ref"></div>
                    <button id="login-mobile" onclick="window.location.href='/manual_login'" class="btns">login</button>
                    {%endif%}
                    {%if not current_user.is_authenticated %}
                    <div onclick="window.location.href='/register'" class="username gen-flex btns">
                        <span class="">Register</span>
                    </div>
                    {%endif%}
                </div>

                <div style="overflow-y: auto; height: calc(100% - 60px);" class="displaying-section"><br>
                    <div style="height: max-content; width: 100%;position: relative;" class="be-scrollable">
                        {% block content %}
                        {% endblock %}
                    </div>
                    <br><br><br> <br><br><br>
                </div>
                
            </div>
        </div>
    </div>

    <div class="mobile-bottom-navigation gen-flex">
        <a id="first-btn" class="bot-navigation-btn" href="/business_community">Business Community</a>
        <a class="bot-navigation-btn" href="/adverts">Advertising</a>
        <a id="last-btn" class="bot-navigation-btn" href="/digital_marketing">Digital Marketing</a>
    </div>

    <script nonce="{{ nonce }}">
        var currentFromServ = {{ current|tojson|safe }};
    </script>
    <!-- <script src="static/js/tempkeys.js" ></script> -->
    <script src="{{ url_for('static', filename='js/indexedb.js') }}"></script>
    <script src="static/js/js_script.js" ></script>
    <script src="static/js/bus_cht.js" ></script>
    <script src="static/js/tempkeys.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    

<script nonce="{{ nonce }}">
// Install in ios 
function isIos() {
    return /iphone|ipad|ipod/i.test(window.navigator.userAgent);
}
function isInStandaloneMode() {
    return ('standalone' in window.navigator) && window.navigator.standalone;
}

function toggleMenu() {
    console.log("Toggling Mobile Menu");
    const menuIcon = document.getElementById('menu-icon-mobile');
    const mobileMenu = document.querySelector('.mobile-menu');
    mobileMenu.classList.toggle('open');
}

let deferredPromptTwo = null;

function isPWAInstalled() {
    if (window.matchMedia('(display-mode: standalone)').matches) return true;
    if (window.navigator.standalone) return true;
    return false;
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPromptTwo = e;
    if (!localStorage.getItem('pwaPromptDismissed') && !isPWAInstalled()) {
        document.getElementById('pwa-install-modal').style.display = 'block';
    }
});

window.addEventListener('appinstalled', () => {
    document.getElementById('pwa-install-modal').style.display = 'none';
    localStorage.setItem('pwaPromptDismissed', '1');
});

document.addEventListener('DOMContentLoaded', function() {
    const installBtn = document.getElementById('pwa-install-btn2');
    const dismissBtn = document.getElementById('pwa-dismiss-btn');

    if (installBtn) {
        installBtn.addEventListener('click', async () => {
            console.log('PWA install prompt');
            if (deferredPromptTwo) {
                deferredPromptTwo.prompt();
                const { outcome } = await deferredPromptTwo.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwa-install-modal').style.display = 'none';
                    localStorage.setItem('pwaPromptDismissed', '1');
                }
                deferredPromptTwo = null;
            }
        });
    }

    if (dismissBtn) {
        dismissBtn.addEventListener('click', () => {
            console.log('PWA install prompt dismissed');
            document.getElementById('pwa-install-modal').style.display = 'none';
            localStorage.setItem('pwaPromptDismissed', '1');
        });
    }

    // Optionally, remind again after a day
    if (localStorage.getItem('pwaPromptDismissed')) {
        setTimeout(() => {
            localStorage.removeItem('pwaPromptDismissed');
        }, 24 * 60 * 60 * 1000); // 24 hours
    }

    
    // iOS: Show custom install instructions if not installed
    if (isIos() && !isInStandaloneMode()) {
        document.getElementById('pwa-install-modal').style.display = 'block';
        document.getElementById('pwa-install-btn2').style.display = 'none';
        document.getElementById('pwa-dismiss-btn').style.display = 'inline-block';
        document.querySelector('#pwa-install-modal p').innerHTML =
            "To install Quick Messenger on your iPhone, tap the <b>Share</b> <img src='static/icons/ios-share.png' style='height:1em;vertical-align:middle;'> button and select <b>'Add to Home Screen'</b>.";
    }
});

function skipRecovery(){
    var recoveryModal = document.getElementById("auto-recovery-modal");
    recoveryModal.style.display = "none";
    // Store the current time in localStorage
    localStorage.setItem('autoRecoveryModalDismissed', Date.now().toString());
};

 document.addEventListener('DOMContentLoaded', function() {
        var navItems = document.querySelectorAll('.side-navbar-nav .side-nav-item, .side-navbar-nav .app-nav-icons');
        var currentPath = window.location.pathname;
        navItems.forEach(function(item) {
            // Try to get the path from the onclick attribute
            var onclick = item.getAttribute('onclick');
            var path = null;
            if (onclick) {
                // Extract the path from: window.location.href='/some_path'
                var match = onclick.match(/window\.location\.href=['"]([^'"]+)['"]/);
                if (match) {
                    path = match[1];
                }
            }
            // If item is an <a> or contains an <a>, use its href
            var link = item.querySelector('a');
            if (link && link.getAttribute('href')) {
                path = link.getAttribute('href');
            }
            // Now compare path to currentPath
            if (path && currentPath === path) {
                navItems.forEach(i => i.classList.remove('active-tab'));
                item.classList.add('active-tab');
                const span = item.querySelector('span');
                document.querySelector("#active-tab-desc").innerHTML = span.textContent;
                console.log("Selected Item: ", span ? span.textContent : '');
            }
        });
    

    console.log("Check Notification Permission: ",Notification.permission);
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    };
    fetch('/log-notification-permission', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ permission: Notification.permission })
    });
        // console.log("SaveIs Called: ");
    var userLabel =document.querySelector("#username-label");
    var goBtn = document.querySelector("#login");
    // var currentFromServ = "{{ current|tojson|safe }}";
    if (userLabel){
        // console.log("User Label",userLabel.textContent);
        initDB().then((db) =>{
            preRegister();
            console.log("db", db.objectStoreNames.contains("keys"));
            console.log("User Found");
            var regMobile = document.querySelector('#register-mobile');
            if(regMobile)(
                regMobile.style.display="none"
            ); 
        });
        }else{
            // initialise DB 
            initDB().then((db) =>{
                console.log("db", db.objectStoreNames.contains("keys"));
                console.log("Base == User Not Found");
                preRegister();
                
                // sessionStorage.setItem("recCredInfo", "NA");
            });
        }

    //Bottom Navigation
    // Get current page path without query params
    const navCurrentPath = window.location.pathname;

    // Loop through all bottom navigation links
    document.querySelectorAll(".bot-navigation-btn").forEach(link => {
        if (link.getAttribute("href") === navCurrentPath) {
            link.classList.add("active");
        }

        // Optional: add click focus behavior
        link.addEventListener("click", () => {
            document.querySelectorAll(".bot-navigation-btn").forEach(btn => btn.classList.remove("active"));
            link.classList.add("active");
        });
    });

});

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js').then(reg => {
                if (!reg.installing && !reg.waiting) {
                    console.log('Service Worker already active.');
                } else {
                    console.log('New Service Worker registered:', reg);
                }
                });
        });

        navigator.serviceWorker.ready.then(function(registration) {
        // Listen for controllerchange to reload page after unregister
        navigator.serviceWorker.addEventListener('controllerchange', function() {
            window.location.reload();
        });

        // Try to fetch the root page to check for network errors
        fetch(window.location.origin + '/')
                .catch(function(err) {
                    console.warn('Service worker fetch failed, unregistering...', err);
                    registration.unregister().then(function() {
                        // After unregister, reload to get a fresh service worker
                        window.location.reload();
                    });
                });
        });
        }

        navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SW_FETCH_ERROR') {
            navigator.serviceWorker.getRegistration().then(function(registration) {
                if (registration) {
                registration.unregister().then(function() {
                    window.location.reload();
                });
                }
            });
            }
        });

    // Function to open the menu
    function openMenuFunc() {
        var navLabels = document.querySelectorAll(".nav-label");
        document.querySelector(".app-nav-bar-left").classList.toggle("open");
        navLabels.forEach(function(label) {
            label.classList.toggle("nav-label-display");
            // label.style.cursor='text';
        });
        // doucument.querySelector(".left-main").classList.toggle("nav-label-display");
    }

    // Function to open/close messages
    function openClose(event) {
        event.stopPropagation();
        const messagesContainer = document.querySelector(".scorllable-messages");
        messagesContainer.classList.toggle("open");
    }

// Universal Progress Indicator
(function() {
    function showLoader() {
        var loader = document.getElementById('global-loader');
        if (loader) loader.style.display = 'flex';
    }
    function hideLoader() {
        var loader = document.getElementById('global-loader');
        if (loader) loader.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Intercept all <a> clicks (except those with target _blank or download)
        document.body.addEventListener('click', function(e) {
            var el = e.target;
            // Check for <a> tag
            while (el && el.tagName !== 'A' && el !== document.body) el = el.parentElement;
            if (el && el.tagName === 'A' && !el.hasAttribute('target') && !el.hasAttribute('download') && el.href && el.origin === window.location.origin) {
                showLoader();
            }
        }, true);

        // Intercept all .side-nav-item clicks
        var navItems = document.querySelectorAll('.side-nav-item.gen-flex');
        navItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                showLoader();
            });
        });
        
        var recItems = document.querySelectorAll('call-loader');
        recItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                showLoader();
            });
        });

        // Show loader on form submit
        document.body.addEventListener('submit', function(e) {
            showLoader();
        }, true);

        // Hide loader when page is loaded
        window.addEventListener('pageshow', hideLoader);
        window.addEventListener('load', hideLoader);
    });

    window.addEventListener('popstate', hideLoader);
})();

// Check if service worker and push manager are supported
document.addEventListener('DOMContentLoaded', async function() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        const registration = await navigator.serviceWorker.getRegistration();
        const subscription = registration ? await registration.pushManager.getSubscription() : null;

        if (!subscription && isPWAInstalled()) {
            const modal = document.getElementById('push-subscribe-modal');
            if (modal) modal.style.display = 'block'; // Show modal if not subscribed
        }
    }
});

 </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/places.js@1.19.0"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
</body>
</html>